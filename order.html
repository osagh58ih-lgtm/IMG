<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Order Checkout</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 30px; text-align: center; }
    .order-box { background: white; max-width: 400px; margin: auto; padding: 25px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h2 { margin-bottom: 20px; }
    .order-box img { width: 150px; border-radius: 10px; margin-bottom: 15px; border: 3px solid #00aaff; }
    input { width: 100%; padding: 10px; margin: 8px 0; border-radius: 6px; border: 1px solid #ccc; font-size: 15px; }
    button { width: 100%; padding: 12px; margin-top: 15px; background: #00aaff; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }
  </style>
</head>
<body>

<div class="order-box">
  <h2>Order Checkout</h2>

  <div id="selectedImageBox"></div>

  <input type="text" id="name" placeholder="Name">
  <input type="tel" id="phone" placeholder="phoneNumber">
  <input type="text" id="address" placeholder="Address">
  <input type="text" id="quatity" placeholder="Count">
  <input type="text" id="size" placeholder="size">
  <input type="text" id="comment" placeholder="Comment">

  <button onclick="sendOrder()">Send Order</button>
</div>

<div id="selectedImageBox"></div>
<script>
const imgBox = document.getElementById("selectedImageBox");

const params = new URLSearchParams(window.location.search);
const imageParam = params.get("img");

let finalImage = null;

if (imageParam && imageParam !== "local") {
  finalImage = imageParam;
}

if (!finalImage) {
  const savedImage = localStorage.getItem("tshirtDesign");
  if (savedImage) {
    finalImage = savedImage;
  }
}

if (finalImage) {
  imgBox.innerHTML = `<img src="${finalImage}">`;
} else {
  imgBox.textContent = "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©";
}

async function sendOrder() {
  const name = document.getElementById("name").value;
  const phone = document.getElementById("phone").value;
  const address = document.getElementById("address").value;
  const quantity = document.getElementById("quatity").value;
  const size = document.getElementById("size").value;

  if (!name || !phone || !address || !quantity || !size || !finalImage) {
    alert("âŒ Ø¨Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    return;
  }

  let uploadedImageURL = finalImage;

  
  if (finalImage.startsWith("data:image")) {
    const formData = new FormData();
    formData.append("image", finalImage);

    try {
      const response = await fetch("upload.php", {
        method: "POST",
        body: formData
      });

      uploadedImageURL = await response.text();

    } catch (err) {
      alert("âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©");
      return;
    }
  }

  const orderMessage = `
Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ğŸ”¥
Ø§Ù„Ø§Ø³Ù…: ${name}
Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ${phone}
Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${address}
Ø§Ù„ÙƒÙ…ÙŠØ©: ${quantity}
Ø§Ù„Ù…Ù‚Ø§Ø³: ${size}
Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ: ${comment}

ØµÙˆØ±Ø© Ø§Ù„ØªØµÙ…ÙŠÙ…:
${uploadedImageURL}
`;

  const phoneNumber = "201207554794";
  const whatsappLink =
    `https://wa.me/${phoneNumber}?text=${encodeURIComponent(orderMessage)}`;

  window.open(whatsappLink, "_blank");

  localStorage.removeItem("tshirtDesign");
}
</script>
</body>
</html>